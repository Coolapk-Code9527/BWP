# ===================================================================
# BPB-Worker-Panel è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ
# ===================================================================
# æè¿°: æ­¤å·¥ä½œæµç”¨äºè‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–° BPB-Worker-Panel çš„ Worker ç»„ä»¶æ–‡ä»¶
# 
# åŠŸèƒ½ï¼š
#   - è‡ªåŠ¨æ£€æµ‹ï¼šæ”¯æŒå®šæ—¶æ£€æµ‹å’Œæ‰‹åŠ¨è§¦å‘ä¸¤ç§æ–¹å¼
#   - ç‰ˆæœ¬ç®¡ç†ï¼šæ”¯æŒæ­£å¼ç‰ˆ(release)å’Œé¢„å‘å¸ƒç‰ˆ(prerelease)ï¼Œè®°å½•ç‰ˆæœ¬ä¿¡æ¯
#   - å¤šæ–‡ä»¶å¤„ç†ï¼šæ”¯æŒåŒæ—¶æ›´æ–°å¤šä¸ªæ–‡ä»¶ï¼Œé…ç½®çµæ´»
#   - å®‰å…¨æœºåˆ¶ï¼šè‡ªåŠ¨å¤‡ä»½æ‰€æœ‰æ›´æ–°æ–‡ä»¶ï¼Œé”™è¯¯æ—¶è‡ªåŠ¨æ¢å¤
#   - æ—¥å¿—ç³»ç»Ÿï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•å’Œé”™è¯¯å¤„ç†ï¼Œä¾¿äºæ•…éšœæ’æŸ¥
#   - è‡ªå®šä¹‰é…ç½®ï¼šå¯é€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®
# ===================================================================

name: Auto Update Worker

# ===================================================================
# é…ç½®åŒºï¼šè§¦å‘æ¡ä»¶ä¸å‚æ•°
# ===================================================================
on:
  # æ¨é€è§¦å‘ (ä»…mainåˆ†æ”¯)
  # å½“æœ‰ä»£ç æ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches: [main]
  
  # å®šæ—¶è§¦å‘ (cronè¯­æ³•)
  # å¯æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©æˆ–è‡ªå®šä¹‰è§¦å‘é¢‘ç‡
  schedule:
    - cron: "0 4 * * *"  # é»˜è®¤ï¼šæ¯å¤©å‡Œæ™¨4ç‚¹è¿è¡Œ
    # - cron: "0 2 * * 1" # å¯é€‰ï¼šæ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹
    # - cron: "0 3 1 * *" # å¯é€‰ï¼šæ¯æœˆ1æ—¥å‡Œæ™¨3ç‚¹
    # - cron: "0 */4 * * *" # å¯é€‰ï¼šæ¯4å°æ—¶è¿è¡Œ
  
  # æ‰‹åŠ¨è§¦å‘
  # æ”¯æŒé€šè¿‡GitHub Actionsç•Œé¢æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:

# æƒé™è®¾ç½®
# éœ€è¦å†™å…¥æƒé™ç”¨äºæäº¤æ›´æ–°åçš„æ–‡ä»¶å’Œç‰ˆæœ¬ä¿¡æ¯
permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥æäº¤æ›´æ”¹

# ===================================================================
# å·¥ä½œæµä»»åŠ¡
# ===================================================================
jobs:
  update:
    name: Update Worker Files
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
      # è·å–å½“å‰ä»£ç åº“çš„æœ€æ–°å†…å®¹
      - name: Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šè®¾ç½®ç»Ÿä¸€ç¯å¢ƒå˜é‡
      # æ‰€æœ‰é…ç½®é¡¹éƒ½åœ¨æ­¤æ­¥éª¤ä¸­è®¾ç½®ï¼Œé¿å…å¤šå¤„å®šä¹‰å¯¼è‡´çš„ç»´æŠ¤å›°éš¾
      - name: Setup Environment
        id: setup
        run: |
          echo "::group::é…ç½®ç¯å¢ƒå˜é‡"
          # åŸºç¡€é…ç½®
          echo "REPO_URL=https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases" >> $GITHUB_ENV  # GitHub APIåœ°å€
          echo "TARGET_FILES=worker.zip" >> $GITHUB_ENV  # è¦æ›´æ–°å’Œå¤‡ä»½çš„æ–‡ä»¶
          echo "VERSION_FILE=version.txt" >> $GITHUB_ENV  # ç”¨äºè®°å½•å½“å‰ç‰ˆæœ¬å·çš„æ–‡ä»¶
          echo "RELEASE_TYPE=prerelease" >> $GITHUB_ENV  # ç‰ˆæœ¬ç±»å‹ï¼šrelease(æ­£å¼ç‰ˆ)æˆ–prerelease(é¢„å‘å¸ƒç‰ˆ)
          echo "FORCE_UPDATE=false" >> $GITHUB_ENV  # æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼štrue(å¼ºåˆ¶)æˆ–false(æ£€æŸ¥ç‰ˆæœ¬)
          echo "ENABLE_OBFUSCATE=true" >> $GITHUB_ENV  # æ˜¯å¦å¯ç”¨æ··æ·†ï¼štrue(å¯ç”¨)æˆ–false(ç¦ç”¨)ï¼Œæ§åˆ¶è‡ªåŠ¨æ··æ·†_worker.js
          
          # åŠŸèƒ½é…ç½®
          echo "MAX_RETRIES=3" >> $GITHUB_ENV  # ä¸‹è½½å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°
          echo "TIMEOUT=30" >> $GITHUB_ENV  # ä¸‹è½½è¶…æ—¶æ—¶é—´(ç§’)
          echo "ENABLE_BACKUP=true" >> $GITHUB_ENV  # å¤‡ä»½åŠŸèƒ½ï¼štrue(å¯ç”¨)æˆ–false(ç¦ç”¨)
          echo "MAX_BACKUPS=2" >> $GITHUB_ENV  # ä¿ç•™çš„æœ€å¤§å¤‡ä»½æ•°é‡ï¼Œ0è¡¨ç¤ºä¸é™åˆ¶
          echo "SKIP_VERIFY=false" >> $GITHUB_ENV  # å‚æ•°éªŒè¯ï¼štrue(è·³è¿‡)æˆ–false(å¯ç”¨)
          echo "LOG_LEVEL=INFO" >> $GITHUB_ENV  # æ—¥å¿—çº§åˆ«ï¼šDEBUG, INFO, WARN, ERROR
          
          # å‘½ä»¤å‚æ•°
          echo "EXCLUDE_PATTERNS=" >> $GITHUB_ENV  # è§£å‹æ—¶æ’é™¤çš„æ–‡ä»¶æ¨¡å¼ï¼Œå¤šä¸ªç”¨ç©ºæ ¼åˆ†éš”
          echo "UNZIP_OPTS=-o" >> $GITHUB_ENV  # è§£å‹å‚æ•°ï¼š-o(è¦†ç›–), -j(å¿½ç•¥ç›®å½•), -q(é™é»˜)
          echo "WGET_OPTS=-q" >> $GITHUB_ENV  # ä¸‹è½½å‚æ•°ï¼š-q(é™é»˜), --show-progress(æ˜¾ç¤ºè¿›åº¦)
          
          # è®°å½•è§¦å‘æ–¹å¼ï¼ˆæ— éœ€åŒºåˆ†å¤„ç†ï¼‰
          echo "âš™ï¸ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "::endgroup::"

      # æ­¥éª¤3ï¼šæ£€æŸ¥å¹¶æ›´æ–°Workeræ–‡ä»¶
      # ä¸»è¦æ‰§è¡Œè„šæœ¬ï¼Œè´Ÿè´£æ£€æŸ¥å’Œæ›´æ–°Workerç»„ä»¶
      - name: Update Worker
        id: update_worker
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub Tokenç”¨äºAPIè®¿é—®
        run: |
          #===================================================================
          # Worker è‡ªåŠ¨æ›´æ–°è„šæœ¬
          #===================================================================

          # åŠ¨æ€ç”Ÿæˆå¤‡ä»½ç›®å½•å
          BACKUP_DIR=".backup_$(date +%Y%m%d%H%M%S)"  # æ¯æ¬¡è¿è¡Œç”Ÿæˆå”¯ä¸€çš„å¤‡ä»½ç›®å½•å

          #===================================================================
          # é€šç”¨å‡½æ•°åŒº
          #===================================================================
          
          # æ—¥å¿—è¾“å‡ºå‡½æ•°
          # å‚æ•°:
          #   $1 - æ—¥å¿—çº§åˆ« (DEBUG, INFO, WARN, ERROR)
          #   $2 - æ—¥å¿—å†…å®¹
          # åŠŸèƒ½: æ ¹æ®é…ç½®çš„LOG_LEVELå†³å®šæ˜¯å¦è¾“å‡ºç‰¹å®šçº§åˆ«çš„æ—¥å¿—
          log() {
            local LEVEL="$1"; local MSG="$2"
            case "$LOG_LEVEL" in
              "DEBUG") :;;  # è¾“å‡ºæ‰€æœ‰çº§åˆ«
              "INFO") [ "$LEVEL" = "DEBUG" ] && return 0;;  # ä¸è¾“å‡ºDEBUG
              "WARN") [[ "$LEVEL" =~ ^(DEBUG|INFO)$ ]] && return 0;;  # åªè¾“å‡ºWARNå’ŒERROR
              "ERROR") [ "$LEVEL" != "ERROR" ] && return 0;;  # åªè¾“å‡ºERROR
            esac
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] [$LEVEL] $MSG"
          }
          
          # æ–‡ä»¶åå®‰å…¨æ ¡éªŒ
          # å‚æ•°: $1 - æ–‡ä»¶å
          # è¿”å›: 0-å®‰å…¨ 1-ä¸å®‰å…¨
          # åŠŸèƒ½: é˜²æ­¢è·¯å¾„éå†æ”»å‡»å’Œç‰¹æ®Šå­—ç¬¦å¼•èµ·çš„é—®é¢˜
          validate_filename() {
            [[ "$1" == *".."* || "$1" == /* ]] && { log ERROR "ä¸å®‰å…¨çš„æ–‡ä»¶å: $1"; return 1; }
            [[ "$1" =~ [^a-zA-Z0-9._\-] ]] && { log WARN "æ–‡ä»¶å $1 åŒ…å«ç‰¹æ®Šå­—ç¬¦"; }
            return 0
          }
          
          # å‘½ä»¤é‡è¯•æ‰§è¡Œ
          # å‚æ•°:
          #   $1 - æè¿°ä¿¡æ¯
          #   $2 - è¦æ‰§è¡Œçš„å‘½ä»¤
          #   $3 - é”™è¯¯æ—¥å¿—æ–‡ä»¶
          #   $@ - å‘½ä»¤çš„å…¶ä»–å‚æ•°
          # åŠŸèƒ½: æ‰§è¡Œå‘½ä»¤å¹¶æ”¯æŒå¤±è´¥é‡è¯•
          execute_with_retry() {
            local DESC="$1"; local CMD="$2"; local ERR="$3"; shift 3; local RETRY=0
            while [ "$RETRY" -lt "$MAX_RETRIES" ]; do
              log INFO "$DESC (å°è¯• $((RETRY+1))/$MAX_RETRIES)..."
              "$CMD" "$@" 2>"$ERR" && { log INFO "$DESC æˆåŠŸ"; rm -f "$ERR"; return 0; }
              RETRY=$((RETRY+1)); log WARN "$DESC å¤±è´¥ ($RETRY/$MAX_RETRIES): $(cat "$ERR")"; sleep 2
            done
            log ERROR "$DESC å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"; rm -f "$ERR"; return 1
          }
          
          # å¤‡ä»½/æ¢å¤æ–‡ä»¶æ“ä½œ
          # å‚æ•°:
          #   $1 - æ“ä½œç±»å‹ (backup/restore)
          #   $2 - æ–‡ä»¶å
          # åŠŸèƒ½: å¤‡ä»½æˆ–æ¢å¤æŒ‡å®šæ–‡ä»¶
          file_operation() {
            # å¦‚æœå¤‡ä»½ç¦ç”¨ä¸”è¯·æ±‚æ¢å¤ï¼Œåˆ™è­¦å‘Šå¹¶è¿”å›
            if [ "$ENABLE_BACKUP" != "true" ] && [ "$1" = "restore" ]; then
              log WARN "å¤‡ä»½åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ— æ³•æ¢å¤æ–‡ä»¶" 
              return 0
            fi
            
            # å¤‡ä»½æ“ä½œ
            if [ "$1" = "backup" ] && [ -f "$2" ]; then
              cp -f "$2" "$BACKUP_DIR/$2" 2>/dev/null
              return $?
            fi
            
            # æ¢å¤æ“ä½œ
            if [ "$1" = "restore" ] && [ -f "$BACKUP_DIR/$2" ]; then
              cp -f "$BACKUP_DIR/$2" "$2" 2>/dev/null
              return $?
            fi
            
            return 0
          }
          
          # æ£€æŸ¥ä¾èµ–
          # åŠŸèƒ½: æ£€æŸ¥å¿…è¦å‘½ä»¤æ˜¯å¦å­˜åœ¨
          check_dependencies() {
            log INFO "æ£€æŸ¥ä¾èµ–..."
            local MISSING=false
            for CMD in jq wget unzip curl; do 
              command -v "$CMD" >/dev/null 2>&1 || { log ERROR "ç¼ºå°‘ä¾èµ–: $CMD"; MISSING=true; }
            done
            [ "$MISSING" = true ] && return 1
            log INFO "ä¾èµ–æ£€æŸ¥é€šè¿‡"; return 0
          }
          
          # å‚æ•°æ ¡éªŒ
          # åŠŸèƒ½: éªŒè¯é…ç½®å‚æ•°çš„æœ‰æ•ˆæ€§
          validate_params() {
            [ "$SKIP_VERIFY" = "true" ] && { log WARN "å·²é…ç½®è·³è¿‡å‚æ•°éªŒè¯"; return 0; }
            log INFO "éªŒè¯å‚æ•°..."
            [[ "$RELEASE_TYPE" != "release" && "$RELEASE_TYPE" != "prerelease" ]] && { 
              log ERROR "RELEASE_TYPE å‚æ•°æ— æ•ˆ: $RELEASE_TYPE"; return 1; }
            [[ -z "$TARGET_FILES" ]] && { log ERROR "TARGET_FILES å‚æ•°ä¸èƒ½ä¸ºç©º"; return 1; }
            log INFO "å‚æ•°éªŒè¯é€šè¿‡"; return 0
          }
          
          # æ¸…ç†æ—§å¤‡ä»½
          # åŠŸèƒ½: ä¿ç•™æœ€æ–°çš„MAX_BACKUPSä¸ªå¤‡ä»½ï¼Œåˆ é™¤æ—§å¤‡ä»½
          cleanup_old_backups() {
            # å¦‚æœæ²¡æœ‰è®¾ç½®å¤‡ä»½é™åˆ¶ï¼Œç›´æ¥è¿”å›
            if [ "$MAX_BACKUPS" -le 0 ]; then 
              log DEBUG "æœªè®¾ç½®æœ€å¤§å¤‡ä»½æ•°é‡é™åˆ¶" 
              return 0
            fi
            
            # æŸ¥æ‰¾æ‰€æœ‰å¤‡ä»½ç›®å½•å¹¶æ’åº
            local BACKUPS=($(find . -maxdepth 1 -type d -name ".backup_*" | sort))
            local COUNT=${#BACKUPS[@]}
            
            # å¦‚æœå¤‡ä»½æ•°é‡æœªè¶…é™åˆ¶ï¼Œç›´æ¥è¿”å›
            if [ "$COUNT" -le "$MAX_BACKUPS" ]; then
              log DEBUG "å¤‡ä»½æ•°é‡($COUNT)æœªè¶…è¿‡æœ€å¤§é™åˆ¶($MAX_BACKUPS)" 
              return 0
            fi
            
            # åˆ é™¤è¶…å‡ºé™åˆ¶çš„æ—§å¤‡ä»½
            log INFO "æ¸…ç†æ—§å¤‡ä»½ï¼šä¿ç•™$MAX_BACKUPSä¸ªï¼Œåˆ é™¤$((COUNT-MAX_BACKUPS))ä¸ª"
            for (( i=0; i<COUNT-MAX_BACKUPS; i++ )); do 
              log INFO "åˆ é™¤æ—§å¤‡ä»½: ${BACKUPS[$i]}"
              rm -rf "${BACKUPS[$i]}"
            done
            
            return 0
          }
          
          # åˆ›å»ºå¤‡ä»½ç›®å½•
          # åŠŸèƒ½: åˆ›å»ºå¤‡ä»½ç›®å½•å¹¶æ¸…ç†æ—§å¤‡ä»½
          create_backup() {
            # å¦‚æœå¤‡ä»½åŠŸèƒ½ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            if [ "$ENABLE_BACKUP" != "true" ]; then
              log WARN "å¤‡ä»½åŠŸèƒ½å·²ç¦ç”¨"
              return 0
            fi
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            log INFO "åˆ›å»ºå¤‡ä»½ç›®å½•: $BACKUP_DIR"
            if ! mkdir -p "$BACKUP_DIR"; then
              log ERROR "åˆ›å»ºå¤‡ä»½ç›®å½•å¤±è´¥"
              return 1
            fi
            
            # æ¸…ç†æ—§å¤‡ä»½
            cleanup_old_backups
            return 0
          }

          #===================================================================
          # åŠŸèƒ½å‡½æ•°åŒº
          #===================================================================
          
          # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          # åŠŸèƒ½: ä»GitHub APIè·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
          # è¿”å›: å…¨å±€å˜é‡ TAG_NAME (ç‰ˆæœ¬å·) å’Œ RESPONSE (APIå“åº”)
          get_latest_version() {
            log INFO "è·å– $RELEASE_TYPE ç‰ˆæœ¬ä¿¡æ¯..."
            
            # è°ƒç”¨GitHub APIè·å–ç‰ˆæœ¬ä¿¡æ¯
            RESPONSE=$(curl -s --retry 3 -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "$REPO_URL")
            if [ $? -ne 0 ]; then
              log ERROR "æ— æ³•è®¿é—® GitHub API"
              return 1
            fi
            
            # JQ_FILTERå…¨å±€å®šä¹‰ï¼Œé¿å…ä½œç”¨åŸŸé—®é¢˜
            if [ "$RELEASE_TYPE" = "prerelease" ]; then
              JQ_FILTER='[.[] | select(.prerelease==true and .draft==false)][0]'
            else
              JQ_FILTER='[.[] | select(.prerelease==false and .draft==false)][0]'
            fi
            
            # è·å–ç‰ˆæœ¬å·
            TAG_NAME=$(echo "$RESPONSE" | jq -r "$JQ_FILTER.tag_name")
            if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "null" ]; then
              log ERROR "æœªæ‰¾åˆ°æœ‰æ•ˆçš„ $RELEASE_TYPE ç‰ˆæœ¬"
              return 1
            fi
            
            log INFO "æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬: $TAG_NAME"
            return 0
          }
          
          # ä¸‹è½½æ–‡ä»¶
          # å‚æ•°:
          #   $1 - æ–‡ä»¶å
          #   $2 - ä¸‹è½½URL
          # åŠŸèƒ½: ä¸‹è½½æŒ‡å®šURLçš„æ–‡ä»¶
          download_file() {
            local FILE="$1"; local URL="$2"
            validate_filename "$FILE" || return 1
            
            # è®¾ç½®ä¸‹è½½å‚æ•°
            local WGET_ARGS=(--timeout="$TIMEOUT" -O "$FILE")
            for arg in $WGET_OPTS; do WGET_ARGS+=("$arg"); done
            WGET_ARGS+=("$URL")
            
            execute_with_retry "ä¸‹è½½æ–‡ä»¶ $FILE" wget "wget_error.log" "${WGET_ARGS[@]}"
            return $?
          }
          
          # è§£å‹æ–‡ä»¶
          # å‚æ•°: $1 - æ–‡ä»¶å
          # åŠŸèƒ½: è§£å‹ä¸‹è½½çš„æ–‡ä»¶
          extract_file() {
            local FILE="$1"
            validate_filename "$FILE" || return 1
            
            # è®¾ç½®è§£å‹å‚æ•°
            local UNZIP_ARGS=()
            for arg in $UNZIP_OPTS; do UNZIP_ARGS+=("$arg"); done
            
            # æ·»åŠ æ’é™¤æ¨¡å¼ï¼ˆå¦‚æœæœ‰ï¼‰
            if [ ! -z "$EXCLUDE_PATTERNS" ]; then
              for pattern in $EXCLUDE_PATTERNS; do UNZIP_ARGS+=(-x "$pattern"); done
              log DEBUG "è§£å‹æ’é™¤æ¨¡å¼: ${EXCLUDE_PATTERNS}"
            fi
            
            UNZIP_ARGS+=("$FILE")
            execute_with_retry "è§£å‹æ–‡ä»¶ $FILE" unzip "unzip_error.log" "${UNZIP_ARGS[@]}" > /dev/null
            return $?
          }
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          # å‚æ•°: $1 - success/fail è¡¨ç¤ºæ›´æ–°ç»“æœ
          # åŠŸèƒ½: æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œæ ¹æ®æ›´æ–°ç»“æœå†³å®šæ˜¯å¦ä¿ç•™å¤‡ä»½
          cleanup() {
            log INFO "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -f wget_error.log unzip_error.log
            
            # å¦‚æœå¤‡ä»½åŠŸèƒ½å·²ç¦ç”¨ï¼Œç›´æ¥è¿”å›
            [ "$ENABLE_BACKUP" != "true" ] && return 0
            
            # æ ¹æ®æ›´æ–°ç»“æœå¤„ç†å¤‡ä»½ç›®å½•
            if [ "$1" == "success" ]; then
              log INFO "æ›´æ–°æˆåŠŸï¼Œåˆ é™¤å¤‡ä»½ç›®å½•"
              rm -rf "$BACKUP_DIR"
            else
              log INFO "ä¿ç•™å¤‡ä»½ç›®å½•: $BACKUP_DIR"
            fi
          }
          
          # å¤„ç†å•ä¸ªæ–‡ä»¶çš„æ›´æ–°æµç¨‹
          # å‚æ•°: $1 - æ–‡ä»¶å
          # åŠŸèƒ½: å®Œæˆå•ä¸ªæ–‡ä»¶çš„ä¸‹è½½ã€å¤‡ä»½ã€è§£å‹å’Œæ¢å¤æµç¨‹
          update_single_file() {
            local TARGET_FILE="$1"
            
            # è·å–ä¸‹è½½é“¾æ¥
            DOWNLOAD_URL=$(echo "$RESPONSE" | jq -r "$JQ_FILTER.assets[] | select(.name == \"$TARGET_FILE\") | .browser_download_url")
            if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" == "null" ]; then
              log ERROR "æœªæ‰¾åˆ° $TARGET_FILE çš„ä¸‹è½½é“¾æ¥"
              return 1
            fi
            
            # å¤‡ä»½å½“å‰æ–‡ä»¶
            file_operation backup "$TARGET_FILE"
            
            # ä¸‹è½½æ–‡ä»¶
            if ! download_file "$TARGET_FILE" "$DOWNLOAD_URL"; then
              log ERROR "ä¸‹è½½ $TARGET_FILE å¤±è´¥ï¼Œå°è¯•æ¢å¤"
              file_operation restore "$TARGET_FILE"
              return 1
            fi

            # åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼Œä»…å¯¹å‹ç¼©åŒ…æ‰§è¡Œè§£å‹ï¼Œæ™®é€šæ–‡ä»¶è·³è¿‡
            case "$TARGET_FILE" in
              *.zip|*.tar.gz|*.tar|*.tgz)
                if ! extract_file "$TARGET_FILE"; then
                  log ERROR "è§£å‹ $TARGET_FILE å¤±è´¥ï¼Œå°è¯•æ¢å¤"
                  file_operation restore "$TARGET_FILE"
                  return 1
                fi
                # è§£å‹åå¯é€‰åˆ é™¤å‹ç¼©åŒ…
                rm -f "$TARGET_FILE"
                ;;
              *)
                log INFO "$TARGET_FILE ä¸ºæ™®é€šæ–‡ä»¶ï¼Œè·³è¿‡è§£å‹"
                ;;
            esac
            log INFO "$TARGET_FILE æ›´æ–°æˆåŠŸ"
            return 0
          }

          #===================================================================
          # ä¸»é€»è¾‘åŒº
          #===================================================================
          main() {
            log INFO "====== å¼€å§‹æ‰§è¡Œ Worker æ›´æ–°æµç¨‹ ======"
            log DEBUG "é…ç½®ä¿¡æ¯: ç‰ˆæœ¬ç±»å‹=${RELEASE_TYPE}, ç›®æ ‡æ–‡ä»¶=${TARGET_FILES}, å¤‡ä»½=${ENABLE_BACKUP}"
            
            # æ­¥éª¤1: ç¯å¢ƒæ£€æŸ¥
            # æ£€æŸ¥å¿…è¦ä¾èµ–å’Œå‚æ•°æœ‰æ•ˆæ€§
            log INFO "æ­¥éª¤1: ç¯å¢ƒæ£€æŸ¥"
            if ! check_dependencies; then
              log ERROR "ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼Œç»ˆæ­¢æ›´æ–°"
              return 1
            fi
            
            if ! validate_params; then
              log ERROR "å‚æ•°éªŒè¯å¤±è´¥ï¼Œç»ˆæ­¢æ›´æ–°"
              return 1
            fi
            
            # æ­¥éª¤2: ç‰ˆæœ¬æ–‡ä»¶æ£€æŸ¥
            # è¯»å–å½“å‰ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º
            log INFO "æ­¥éª¤2: ç‰ˆæœ¬æ£€æŸ¥"
            if [ ! -f "$VERSION_FILE" ]; then
              log WARN "$VERSION_FILE ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º"
              echo "" > "$VERSION_FILE"
            fi
            
            LOCAL_VERSION=$(cat "$VERSION_FILE")
            log INFO "æœ¬åœ°ç‰ˆæœ¬: ${LOCAL_VERSION:-æ— }"
            
            # æ­¥éª¤3: è·å–æœ€æ–°ç‰ˆæœ¬
            # ä»GitHub APIè·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
            if ! get_latest_version; then
              log ERROR "è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥ï¼Œç»ˆæ­¢æ›´æ–°"
              return 1
            fi
            
            # æ­¥éª¤4: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
            # æ¯”è¾ƒæœ¬åœ°ç‰ˆæœ¬å’Œè¿œç¨‹ç‰ˆæœ¬ï¼Œæˆ–æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶æ›´æ–°
            if [ "$LOCAL_VERSION" = "$TAG_NAME" ] && [ "$FORCE_UPDATE" != "true" ]; then
              log INFO "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
              echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
              log INFO "====== Worker æ›´æ–°æµç¨‹å®Œæˆ (æ— éœ€æ›´æ–°) ======"
              return 0
            fi
            
            # æ­¥éª¤5: æ–‡ä»¶æ›´æ–°
            # åˆ›å»ºå¤‡ä»½å¹¶ä¸‹è½½æ›´æ–°æ‰€æœ‰ç›®æ ‡æ–‡ä»¶
            log INFO "æ­¥éª¤5: å¼€å§‹æ›´æ–°æ–‡ä»¶"
            if ! create_backup; then
              log ERROR "åˆ›å»ºå¤‡ä»½å¤±è´¥ï¼Œç»ˆæ­¢æ›´æ–°"
              return 1
            fi
            
            UPDATE_SUCCESS=true
            IFS=',' read -ra FILES <<< "$TARGET_FILES"
            for TARGET_FILE in "${FILES[@]}"; do
              log INFO "å¤„ç†æ–‡ä»¶: $TARGET_FILE"
              if ! update_single_file "$TARGET_FILE"; then
                UPDATE_SUCCESS=false
                log ERROR "æ–‡ä»¶ $TARGET_FILE æ›´æ–°å¤±è´¥"
              fi
            done
            
            # æ­¥éª¤6: æ›´æ–°ç»“æœå¤„ç†
            # æ ¹æ®æ›´æ–°ç»“æœæ›´æ–°ç‰ˆæœ¬å·æˆ–æ¢å¤å¤‡ä»½
            if [ "$UPDATE_SUCCESS" = true ]; then
              echo "$TAG_NAME" > "$VERSION_FILE"
              log INFO "æ›´æ–°å®Œæˆï¼Œæ–°ç‰ˆæœ¬: $TAG_NAME"
              echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
              cleanup success
              log INFO "====== Worker æ›´æ–°æµç¨‹å®Œæˆ (æ›´æ–°æˆåŠŸ) ======"
              return 0
            else
              log WARN "éƒ¨åˆ†æ–‡ä»¶æ›´æ–°å¤±è´¥ï¼Œç‰ˆæœ¬å·æœªæ›´æ–°"
              cleanup fail
              log INFO "====== Worker æ›´æ–°æµç¨‹å®Œæˆ (éƒ¨åˆ†å¤±è´¥) ======"
              return 1
            fi
          }
          
          # æ‰§è¡Œä¸»é€»è¾‘
          main

      # æ­¥éª¤3.5ï¼šæ··æ·† Worker æ–‡ä»¶ï¼ˆä½å¼ºåº¦ï¼Œå¯é…ç½®å¼€å…³ï¼‰
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: Install javascript-obfuscator
        run: npm install -g javascript-obfuscator

      - name: Obfuscate _worker.js (Configurable)
        # æ ¹æ® ENABLE_OBFUSCATE é…ç½®é¡¹å†³å®šæ˜¯å¦æ‰§è¡Œæ··æ·†ï¼Œæ‰€æœ‰å‚æ•°å‡æœ‰è¯¦ç»†æ³¨é‡Š
        run: |
          if [ "$ENABLE_OBFUSCATE" = "true" ]; then
            if [ -f "edgetunnel-main/_worker.js" ]; then
              # æ··æ·†å‚æ•°è¯´æ˜ï¼š
              # --compact true                # å¯ç”¨ä»£ç å‹ç¼©ï¼Œå»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
              # --identifier-names-generator mangled  # å˜é‡/å‡½æ•°åæ··æ·†æ–¹å¼ï¼šmangled(çŸ­å) æˆ– hexadecimal(åå…­è¿›åˆ¶)
              # --rename-globals false        # æ˜¯å¦é‡å‘½åå…¨å±€å˜é‡ï¼ˆtrueæ›´å¼ºï¼Œå…¼å®¹æ€§ç•¥ä½ï¼‰
              # --string-array false          # æ˜¯å¦å¯ç”¨å­—ç¬¦ä¸²æ•°ç»„æ··æ·†ï¼ˆtrueæ›´å¼ºï¼Œå…¼å®¹æ€§ç•¥ä½ï¼‰
              # --string-array-encoding 'rc4' # å­—ç¬¦ä¸²æ•°ç»„åŠ å¯†æ–¹å¼ï¼ˆ'rc4'/'base64'ï¼Œéœ€é…åˆstring-array trueï¼‰
              # --string-array-threshold 1    # å­—ç¬¦ä¸²æ•°ç»„æ··æ·†å¼ºåº¦ï¼ˆ0-1ï¼Œ1ä¸ºå…¨éƒ¨å­—ç¬¦ä¸²ï¼‰
              # --control-flow-flattening false # æ§åˆ¶æµæ‰å¹³åŒ–ï¼ˆtrueæ›´å¼ºï¼Œå…¼å®¹æ€§ç•¥ä½ï¼‰
              # --control-flow-flattening-threshold 1 # æ§åˆ¶æµæ‰å¹³åŒ–å¼ºåº¦ï¼ˆ0-1ï¼‰
              # --dead-code-injection false   # æ­»ä»£ç æ³¨å…¥ï¼ˆtrueæ›´å¼ºï¼Œå…¼å®¹æ€§ç•¥ä½ï¼‰
              # --dead-code-injection-threshold 1 # æ­»ä»£ç æ³¨å…¥å¼ºåº¦ï¼ˆ0-1ï¼‰
              # --transform-object-keys false # å¯¹è±¡é”®åæ··æ·†ï¼ˆtrueæ›´å¼ºï¼Œå…¼å®¹æ€§ç•¥ä½ï¼‰
              # --unicode-escape-sequence false # å­—ç¬¦ä¸²è½¬Unicodeè½¬ä¹‰ï¼ˆtrueæ›´å¼ºï¼Œå…¼å®¹æ€§ç•¥ä½ï¼‰

              javascript-obfuscator edgetunnel-main/_worker.js --output edgetunnel-main/_worker.js \
                --compact true \
                --identifier-names-generator mangled \
                --rename-globals true \
                --string-array true \
                --string-array-rotate true \
                --string-array-shuffle true \
                --string-array-wrappers-count 5 \
                --string-array-wrappers-type 'variable' \
                --numbers-to-expressions true \
                --split-strings true \
                --split-strings-chunk-length 5 \
            else
              echo "æœªæ‰¾åˆ° edgetunnel-main/_worker.jsï¼Œè·³è¿‡æ··æ·†"
            fi
          else
            echo "æœªå¯ç”¨æ··æ·†ï¼ˆENABLE_OBFUSCATE=falseï¼‰ï¼Œç›´æ¥è·³è¿‡"
          fi

      # æ­¥éª¤4ï¼šæäº¤æ›´æ”¹
      # ä»…åœ¨æ›´æ–°æˆåŠŸæ—¶æäº¤æ›´æ”¹åˆ°ä»£ç åº“
      - name: Commit Changes
        if: success() # ä»…åœ¨æ›´æ–°æˆåŠŸæ—¶æäº¤
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker ç‰ˆæœ¬: ${{ steps.update_worker.outputs.tag_name || 'æœªçŸ¥' }}"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
